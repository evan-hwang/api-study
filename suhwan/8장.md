# 안전한 API 디자인하기

- API 디자인에 있어 사용자가 이해하기 쉽고 사용성이 좋도록 만드는건 두말할 필요 없이 중요하지만 보안에 대한 고민이 없으면 Useless
- API가 노출되서 USERID를 바꿔서 호출한다던가 보안 사고가 발생할 수 있따.



#### 컨슈머 등록하기

- API를 안전하게 만들기 위해서는 허용된 컨슈머만 API를 사용하도록 해야한다.
- 컨슈머로 등록할 수 있도록 개발자 포털을 사용할 수 있어야하고 API포털의 사용자로 등록해야한다.
- 또한 개발자들은 컨슈머가 API의 어떤 스코프까지 사용할지 선택하도록 한다**(권한)**
  - 송금하기 , 계좌 관리, 계좌 내역 조회 등과 같은 기능들에 대하여 사용할 수 있는 권한을 설정해주어야함.



#### 자격증명 가져오기.

- 자격증명을 위해 인증서버를 통해 토큰을 가져오고 권한을 받는 프로세스가 필요함.
- 인증서버로 인증정보를 리퀘스트를 통해 전달한다.
- 브라우저 창이 인증 서버의 URL을 가리키고 인증서버가 리퀘스트를 받게 되면 클라이언트 ID가 알려진 컨슈머가 맞는지 확인.
- 입력된 아이디와 비밀번호가 적합한지 확인한다.
- 올바르다면 액세스 토큰을 생성한다. 그리고 이를 클라이언트에게 전달한다.
- 이는 안전한 채널에서 이루어져야 하며 TLS가 쓰인다.



#### API호출하기

- 은행 API를 호출하게 될때 인증에서 받은 토큰을 포함하여 요청하게 된다.
- 가장 먼저 API는 부여된 스코프에 포함되는지 확인한다(권한)
- 권한이 있으면 다음단계로 진행하게된다.



#### 보안성 관점에서 API 구상하기

- 컨슈머와 프로바이더 사이의 커뮤니케이션은 안전한 채널 상에서 진행되어야한다.
- 또한 API에 등록된 컨슈머만 최종 사용자에게 부여된 권한만큼 접근할 수 있다.
- 설계상 안전한 API를 만드려면 응용 프로그램 접근 제어, 최종 사용자 접근 제어 및 민감한 자료를 관리해야함.



#### API 분할을 통한 접근 제어 활성화

- OWASP에 따르면 애플리케이션에 추가 되는 모든 기능은 전체 위험을 가중시킴. 안전을 추구하는 개발의 목표는 공격이 가능한 영역을 줄여 전체적인 위험을 줄이는 것이다.
- 컨슈머가 접근 가능한 영역에 꼭 필요한 수준으로 제한을 둠으로써 공격에 대한 가능성을 줄일 수 있다 .(최소 권한의 법칙)
- 개발자가 API를 사용할 컨슈머를 등록할 때 적절한 스코프를 통해 제한을 두어야함.



#### 유연하고 정제된 스코프 정의하기.

- 스코프를 정의하는 가장 단순한 방법은 무식하게 목표별로 스코프를 나누는 것이다.
- 목표의 기본 컨셉(account, transaction, transsfer)을 식별하고
- 스코프 별로 CRUD 액션을 정의한다. {컨셉} : {CRUD}
- 여기서 더나아가 보안 스코프를 위해 정재하여 커스텀 액션을 취해 액션을 나눈다.
  - Account:read 와 같은 방식으로 접근 권한에 대해 표시할 수 있다.
  - ransfer:update 의 경우 송금에 대해 수정하는 기능이지만 이로써는 비정상 송금 검증에 대해서는 표현할 수 없다. 따라서 커스텀 액션을 만들어
  - transfer:validate 라는 액션을 만들어 표현해준다.



#### 굵직한 스코프 정의하기

- 굵직하게 스코프를 정의해보자.
- 카테고리 기반으로 정의하게 된다면 계좌, 송금 내역 이렇게 굵직하게 기능들을 묶어 카테고라이징 할 수 있다.
- 하지만 송금 내역은 송금에 대한 너무 많은 권한을 부여한다.
- 이를 위해서 역할과 가능성 기반으로 스코프를 정의한다.
  - (송금이라고 통째로 역할을 나누기보단 Role 기반으로 각각의 기능을 준다.)
  - 계좌 소유자들 -> 송금, 송금 목록 관리, 계좌정보 접근
  - 은행 관리자 -> 비정상 송금 검증
- 이렇게 Role을 통해 스코프를 크게 묶을 수 있다.
- 유연하게 정의된 스코프 -> 굵직한 role기반의 스코프를 이루는 단위가 될 수 있다.





#### 스코프 전략 선택하기

- 스코프 전략은 임의로 적절하게 선택하는 것이지만 한가지를 딱 선택할 필요없다. -> 섞어서 유연하게 사용하자.
- beneficiary:read, beneficiary:delete의 목표를 role 기반으로 beneficiary:admin에 포함시킬 수 있다. 
- 또한 세번째 레벨의 스코프를 추가해서 포함할 수도 있다.



#### API 명세 포맷으로 스코프 정의하기

- API명세에 스코프에 대한 명세가 포함될 수 있다는 이야기..



#### 접근제어를 고려한 설계

- 객실의 카드키가 있다고 가정하면 이 카드키는 호텔의 여러 편의시설을 사용할 수 있게 해준다. 카드키는 자신의 객실문만 열 수 있고 다른사람들은 열 수 없다.
- 관리인은 모든 객실을 열 수 있는 권한이 있을 수도 잇고 특정층만 열 수 있는 권한이 있을 것이다. 이러한 접근에 대한 데이터들과 디자인에 조정되어야 할 부분이 어디인지 알 수 있어야 한다.



#### 접근 제어에 필용한 데이터 이해하기

- 은행 애플리케이션이 계좌 목록에 대한 권한을 부여받았다고해서 모든 계좌에 접근이 허용되는 것은 아니다.
- `/account` API 를 호출하는 것의 결과 동작은 오로지 최종 사용자에 의해서만 달라진다.
- 사용자는 자신의 액세스 토큰을 포함하여 호출한다. ( 이에는 보안과 관련된 데이터들도 포함되어 있다.)
- 액세스 토큰은 id와 role과 같은 정보가 포함되고 이를 통해 사용자의 접근에 대한 제어를 한다.



#### 필요에 따른 디자인 조정

- 송금이라는 목표가 있을때 POST `/transfer` 를 통해 amount, source, destination을 바디로 내려주어 API 목표를 수행할 수 있다.
- 은행 관리자 앱에서 고객에 대한 이체목록 등을 알기 위해 custormerId를 path에 포함하는 방식으로 다시 설계할 수있다.
  - `/customers/{customerId}/transfer`



#### 민감 요소의 취급

- API를 통해 요청, 제공 수행할 수 있는 작업에 민감한 요소가 포함되는지를 항상 확인해야함.



#### 민감한 데이터 취급하기

- 카드에 대한 정보를 노출할때 카드번호, cvv, 소유자의 이름, 만료일자 같은 데이터는 매우 민감한 데이터이다.
- 이러한 데이터를 반환할 때는 다시 한번 생각해 볼 필요가 있다.
- CVV는 카드에 입력되어 있기 때문에 직접 반환해줄 필요가 없다. (내부적으로 입력받아서 처리)
- 안전한 API를 위해서는 이렇게 민감한 데이터를 먼저 식별해야한다.
- 두번째는 해당 데이터에 적절한 표현을 선택하는 것이다.
  1. 제거 -> 민감한 정보는 안보여준다.
  2. 변경 -> 일부분을 변경하여 (카드번호의 일부분만 보여준다던가) 보여준다.
  3. 모하한값으로 대체 -> 상호, 사업장 속성을 민감하지 않은 type속성으로 변경
  4. 암호화 -> 그냥 식별할 수 없게 암호화 한다.



#### 민감한 목표 취급하기.

- 민감한 데이터에 대한 접근 권한을 통제하는 것이 필요.
  1. 목표를 분리하여 설계 ( 민감한 데이터를 보여주는 / 안보여주는 API로 분리)
  2. 스코프에 따라서 동일한 API에서 민감한 데이터를 보여준다.
  3. 권한에 따라서 반환해준다.
  4. 스코프 || 권한에 따라 민감한 데이터를 반환해준다.



#### 안전한 에러 피드백 디자인

- 에러의 반환에 있어 민감한 정보를 노출하면 안된다.
  - 예를 들어 PATCH /cards/c4ca76을 호출했는데 카드 12341253 변경할 수없다.
    - 카드의 정보가 노출되는 상황이 발생한다.
- 또한 4xx 에러와 달리 5xx 에러는 인터널 서버에러인데 여기서 발생하는 문제에 대한 에러가 시스템에 노출된다면 에러에 대한 힌트를 제공할 수 있으므로 숨겨야한다.



