# 안전한 API 디자인하기

- API 디자인에 있어 사용자가 이해하기 쉽고 사용성이 좋도록 만드는건 두말할 필요 없이 중요하지만 보안에 대한 고민이 없으면 Useless
- API가 노출되서 USERID를 바꿔서 호출한다던가 보안 사고가 발생할 수 있따.



#### 컨슈머 등록하기

- API를 안전하게 만들기 위해서는 허용된 컨슈머만 API를 사용하도록 해야한다.
- 컨슈머로 등록할 수 있도록 개발자 포털을 사용할 수 있어야하고 API포털의 사용자로 등록해야한다.
- 또한 개발자들은 컨슈머가 API의 어떤 스코프까지 사용할지 선택하도록 한다**(권한)**
  - 송금하기 , 계좌 관리, 계좌 내역 조회 등과 같은 기능들에 대하여 사용할 수 있는 권한을 설정해주어야함.



#### 자격증명 가져오기.

- 자격증명을 위해 인증서버를 통해 토큰을 가져오고 권한을 받는 프로세스가 필요함.
- 인증서버로 인증정보를 리퀘스트를 통해 전달한다.
- 브라우저 창이 인증 서버의 URL을 가리키고 인증서버가 리퀘스트를 받게 되면 클라이언트 ID가 알려진 컨슈머가 맞는지 확인.
- 입력된 아이디와 비밀번호가 적합한지 확인한다.
- 올바르다면 액세스 토큰을 생성한다. 그리고 이를 클라이언트에게 전달한다.
- 이는 안전한 채널에서 이루어져야 하며 TLS가 쓰인다.



#### API호출하기

- 은행 API를 호출하게 될때 인증에서 받은 토큰을 포함하여 요청하게 된다.
- 가장 먼저 API는 부여된 스코프에 포함되는지 확인한다(권한)
- 권한이 있으면 다음단계로 진행하게된다.



#### 보안성 관점에서 API 구상하기

- 컨슈머와 프로바이더 사이의 커뮤니케이션은 안전한 채널 상에서 진행되어야한다.
- 또한 API에 등록된 컨슈머만 최종 사용자에게 부여된 권한만큼 접근할 수 있다.
- 설계상 안전한 API를 만드려면 응용 프로그램 접근 제어, 최종 사용자 접근 제어 및 민감한 자료를 관리해야함.



#### API 분할을 통한 접근 제어 활성화

- OWASP에 따르면 애플리케이션에 추가 되는 모든 기능은 전체 위험을 가중시킴. 안전을 추구하는 개발의 목표는 공격이 가능한 영역을 줄여 전체적인 위험을 줄이는 것이다.
- 컨슈머가 접근 가능한 영역에 꼭 필요한 수준으로 제한을 둠으로써 공격에 대한 가능성을 줄일 수 있다 .(최소 권한의 법칙)
- 개발자가 API를 사용할 컨슈머를 등록할 때 적절한 스코프를 통해 제한을 두어야함.



#### 유연하고 정제된 스코프 정의하기.

- 스코프를 정의하는 가장 단순한 방법은 무식하게 목표별로 스코프를 나누는 것이다.
- 목표의 기본 컨셉(account, transaction, transsfer)을 식별하고
- 스코프 별로 CRUD 액션을 정의한다. {컨셉} : {CRUD}
- 여기서 더나아가 보안 스코프를 위해 정재하여 커스텀 액션을 취해 액션을 나눈다.
  - Account:read 와 같은 방식으로 접근 권한에 대해 표시할 수 있다.
  - ransfer:update 의 경우 송금에 대해 수정하는 기능이지만 이로써는 비정상 송금 검증에 대해서는 표현할 수 없다. 따라서 커스텀 액션을 만들어
  - transfer:validate 라는 액션을 만들어 표현해준다.



#### 굵직한 스코프 정의하기

- 굵직하게 스코프를 정의해보자.
- 카테고리 기반으로 정의하게 된다면 계좌, 송금 내역 이렇게 굵직하게 기능들을 묶어 카테고라이징 할 수 있다.
- 하지만 송금 내역은 송금에 대한 너무 많은 권한을 부여한다.
- 이를 위해서 역할과 가능성 기반으로 스코프를 정의한다.
  - (송금이라고 통째로 역할을 나누기보단 Role 기반으로 각각의 기능을 준다.)
  - 계좌 소유자들 -> 송금, 송금 목록 관리, 계좌정보 접근
  - 은행 관리자 -> 비정상 송금 검증
- 이렇게 Role을 통해 스코프를 크게 묶을 수 있다.
- 유연하게 정의된 스코프 -> 굵직한 role기반의 스코프를 이루는 단위가 될 수 있다.





#### 스코프 전략 선택하기

- 스코프 전략은 임의로 적절하게 선택하는 것이지만 한가지를 딱 선택할 필요없다. -> 섞어서 유연하게 사용하자.
- beneficiary:read, beneficiary:delete의 목표를 role 기반으로 beneficiary:admin에 포함시킬 수 있다. 
- 또한 세번째 레벨의 스코프를 추가해서 포함할 수도 있다.



#### API 명세 포맷으로 스코프 정의하기

- API명세에 스코프에 대한 명세가 포함될 수 있다는 이야기..



#### 접근제어를 고려한 설계

- 



